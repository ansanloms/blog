<!DOCTYPE html>
<html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Raspberry Pi 4 に mirakc を導入しました</title><script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ress@5.0.2/dist/ress.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;300;400;500;700;900&amp;display=swap"><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/article.css"></head><body><header><a href="/">ansanloms blog</a></header><div class="container"><article class="article"><h1>Raspberry Pi 4 に mirakc を導入しました</h1><div><p>Raspberry Pi 4 (Ubuntu Server 21.04) でテレビを見られるようにしました。</p>
<h2>用意したもの</h2>
<ul>
<li><a href="/articles/20210503-raspberry-pi">先日セットアップした Raspberry Pi 4</a></li>
<li>TV チューナー: <a href="https://www.amazon.co.jp/dp/B079YD3QT3">PLEX PX-Q1UD</a></li>
<li>IC カードリーダー: <a href="https://www.amazon.co.jp/dp/B003XF2JJY">Gemalto IDBridge CT30</a></li>
</ul>
<p>B-CAS カードは古いテレビから拝借しました。</p>
<h2>チューナーの設定</h2>
<p>TV チューナーのドライバをインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ cd /usr/local/src
$ sudo wget http://plex-net.co.jp/plex/px-s1ud/PX-S1UD_driver_Ver.1.0.1.zip
$ sudo unzip PX-S1UD_driver_Ver.1.0.1.zip
$ sudo cp ./PX-S1UD_driver_Ver.1.0.1/x64/amd64/isdbt_rio.inp /lib/firmware/.
</code></pre>
<p>再起動後の Raspberry Pi に PX-Q1UD を接続し、確認します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ dmesg | grep PX-S1UD
</code></pre>
<p><code>PX-S1UD Digital TV Tuner</code> が見えれば OK です。</p>
<p>もしも <code>dmesg: read kernel buffer failed: Operation not permitted</code>
みたいな表示がされた場合、これは通常ユーザにてアクセスできない設定になっています。</p>
<p><code>kernel.dmesg_restrict</code> を OFF にして <code>dmesg</code> を実行できるか確認します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo sysctl kernel.dmesg_restrict=0
</code></pre>
<p>問題なく実行できたならば sysctl の設定に追記しておきます。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo echo "kernel.dmesg_restrict=0" &gt; /etc/sysctl.d/10-local.conf
$ sudo /sbin/sysctl --system
</code></pre>
<h2>カードリーダーの設定</h2>
<p>カードリーダーのスキャンを行う為に <code>pcsc-tools</code> をインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo apt install pcscd pcsc-tools
</code></pre>
<p>Raspberry Pi に B-CAS カードを挿入したカードリーダーを接続し、確認します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo pcsc_scan
</code></pre>
<p><code>Japanese Chijou Digital B-CAS Card (pay TV)</code> の表記が確認できれば切って大丈夫です。</p>
<p><code>SCardEstablishContext: Service not available.</code> と表示された場合は pcscd が起動していないので起動します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">sudo systemctl enable pcscd
sudo systemctl start pcscd
</code></pre>
<p><code>Unresponsive card</code> とか表示された場合はカードが認識されていません。カードを抜き差しして再度確認してみてください。</p>
<h2>recdvb のインストール</h2>
<p>B-CAS デコード用のライブラリをインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo apt install cmake g++ libpcsclite-dev
$ cd /usr/local/src
$ sudo git clone https://github.com/stz2012/libarib25
$ cd libarib25
$ sudo cmake .
$ sudo make
$ sudo make install
</code></pre>
<p>recdvb をインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo apt install automake
$ cd /usr/local/src
$ sudo git clone https://github.com/ansanloms/recdvb.git
$ cd recdvb
$ sudo chmod +x ./autogen.sh
$ sudo ./autogen.sh
$ sudo ./configure --enable-b25
$ sudo EXTRA_SID=1 make
$ sudo make install
</code></pre>
<p>録画できることを確認します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ recdvb --b25 --strip --dev 0 14 3 /mnt/media/test.m2ts
</code></pre>
<p>問題なければ 14 物理チャンネルを 3 秒録画されたものが <code>/mnt/media/test.m2ts</code> に出力されます。</p>
<h2>mirakc のインストール</h2>
<p><a href="https://mirakc.github.io/dekiru-mirakc/">mirakc</a> をインストールします。公式には docker
でのインストールを推奨していますがいろいろあって自前でビルドします。</p>
<p>先に <a href="https://github.com/mirakc/mirakc-arib">mirakc-arib</a> をインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo apt install autoconf ninja-build pkg-config libtool
$ cd /usr/local/src
$ sudo git clone --recursive https://github.com/mirakc/mirakc-arib.git
$ cd mirakc-arib
$ sudo cmake -S . -B build -G Ninja -D CMAKE_BUILD_TYPE=Release
$ sudo ninja -C build vendor
$ sudo ninja -C build
$ sudo cp ./build/bin/mirakc-arib /usr/local/bin/.
</code></pre>
<p>mirakc をインストールする為に先ずは <a href="https://www.rust-lang.org/">Rust</a> をインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
$ source $HOME/.cargo/env
</code></pre>
<p>続いて mirakc をインストールします。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo apt install libfuse-dev
$ cd /usr/local/src
$ sudo git clone https://github.com/mirakc/mirakc.git
$ sudo chown -R $(whoami) mirakc
$ cd mirakc
$ cargo build --release
$ sudo cp ./target/release/mirakc /usr/local/bin/.
$ sudo cp ./target/release/mirakc-timeshift-fs /usr/local/bin/.
</code></pre>
<p>設定ファイル <code>/etc/mirakc/config.yml</code> を用意します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo mkdir -p /etc/mirakc
$ sudo mkdir -p /var/lib/mirakc/epg
$ sudo vim /etc/mirakc/config.yml
</code></pre>
<pre class="language-none" tabindex="0"><code class="language-yaml:/etc/mirakc/config.yml language-none">server:
  addrs:
    - !http '0.0.0.0:40772'
  workers: 1

mirakurun:
  openapi-json: /etc/mirakc/mirakurun.openapi.json

# Ex: 東京のチャンネル設定
channels:
  - name: ＮＨＫ総合
    type: GR
    channel: '27'
  - name: ＮＨＫＥテレ
    type: GR
    channel: '26'
  - name: 日テレ
    type: GR
    channel: '25'
  - name: ＴＢＳ
    type: GR
    channel: '22'
  - name: フジテレビ
    type: GR
    channel: '21'
  - name: テレビ朝日
    type: GR
    channel: '24'
  - name: テレビ東京
    type: GR
    channel: '23'
  - name: ＴＯＫＹＯ　ＭＸ
    type: GR
    channel: '16'

tuners:
  - name: PX-Q1UD-1
    types:
      - GR
    command: recdvb --b25 --strip --dev 0 {{{channel}}} - -

epg:
  cache-dir: /var/lib/mirakc/epg
</code></pre>
<p>mirakc の起動に <code>strings.yml</code> および <code>mirakurun.openapi.json</code> が必要なので、これをオフィシャルの
<a href="https://hub.docker.com/r/mirakc/mirakc">Docker image</a> より取得します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo apt install docker.io
$ sudo docker create mirakc/mirakc
$ sudo docker cp [CONTAINER ID]:/etc/mirakc/strings.yml /etc/mirakc/strings.yml
$ sudo docker cp [CONTAINER ID]:/etc/mirakurun.openapi.json /etc/mirakc/mirakurun.openapi.json
</code></pre>
<p>起動してみます。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo mirakc -c /etc/mirakc/config.yml
</code></pre>
<p>別途ターミナル上で API にアクセスできるか確認します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ curl http://localhost:40772/api/version
</code></pre>
<p><code>"0.18.0"</code> みたいな出力がされれば問題ないです。</p>
<h2>mirakc をサービスに登録する</h2>
<p>systemd の設定ファイル <code>/etc/systemd/system/mirakc.service</code> を用意します。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo vim /etc/systemd/system/mirakc.service
</code></pre>
<pre class="language-none" tabindex="0"><code class="language-ini:/etc/systemd/system/mirakc.service language-none">[Unit]
Description = mirakc

[Service]
ExecStart = /usr/local/bin/mirakc -c /etc/mirakc/config.yml
Restart = always
Type = simple

[Install]
WantedBy = multi-user.target
</code></pre>
<p>有効にし、起動してみます。</p>
<pre class="language-none" tabindex="0"><code class="language-none">$ sudo systemctl enable mirakc
$ sudo systemctl start mirakc
</code></pre>
<h2>おわり</h2>
<p>あとはホスト側に <a href="https://github.com/DBCTRADO/TVTest">TVTest</a> +
<a href="https://github.com/epgdatacapbon/BonDriver_mirakc">BonDriver_mirakc</a> (Windows)
や <a href="https://github.com/ci7lus/MirakTest">MirakTest</a> (Windows / macOS)
等のクライアントアプリを導入します。</p>
<h2>参考にしたドキュメント</h2>
<ul>
<li><a href="https://mirakc.github.io/dekiru-mirakc/">https://mirakc.github.io/dekiru-mirakc/</a></li>
<li><a href="https://hiroto-k.hatenablog.com/entry/2020/03/06/190000">https://hiroto-k.hatenablog.com/entry/2020/03/06/190000</a></li>
<li><a href="https://nyanonon.hatenablog.com/entry/20191114/1573731890">https://nyanonon.hatenablog.com/entry/20191114/1573731890</a></li>
</ul>
</div></article></div><footer>(C) <a href="https://twitter.com/ansanloms">ansanloms</a></footer></body></html>